<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Manage Listings</title>
<style>
body { font-family: Arial, sans-serif; max-width: 1000px; margin: auto; padding: 20px; background: #f4f4f4; }
h1 { text-align: center; }
nav { text-align: center; margin-bottom: 10px; }
nav a { margin: 0 10px; text-decoration: none; color: #fff; background: #28a745; padding: 6px 10px; border-radius: 3px; font-size: 14px; }
#sectorFilter { margin-top: 10px; padding: 4px; font-size: 13px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
th, td { border:1px solid #ccc; padding: 6px; text-align: left; vertical-align: top; }
th { background: #28a745; color: #fff; }
button { padding: 4px 8px; margin: 2px; background:#28a745; color:#fff; border:none; border-radius:3px; cursor:pointer; font-size:12px; }
.sold { background:#d3d3d3; }
.listingImg { max-width:80px; max-height:60px; display:inline-block; margin:2px; cursor:pointer; border:1px solid #ccc; border-radius:3px; }
#lightboxModal { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; align-items:center; justify-content:center; z-index:1000; display:none; }
#lightboxModal img { max-width:90%; max-height:90%; border:3px solid #fff; }
#lightboxModal button { position:absolute; top:50%; font-size:24px; background:none; color:#fff; border:none; cursor:pointer; }
#prevImg { left:20px; }
#nextImg { right:20px; }
</style>
</head>
<body>

<h1>Admin - Manage Listings</h1>

<nav>
    <a href="dashboard.html">Dashboard</a>
    <a href="browse.html">Browse Listings</a>
</nav>

<label for="sectorFilter">Filter by Sector:</label>
<select id="sectorFilter" onchange="renderListings()">
    <option value="All">All</option>
    <option>Restaurants</option>
    <option>Clinics / Healthcare</option>
    <option>Manufacturing / Workshops</option>
    <option>Offices</option>
    <option>Other</option>
</select>

<table id="listingsTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>Sector</th>
            <th>Price (£)</th>
            <th>Quantity</th>
            <th>Condition</th>
            <th>Tags</th>
            <th>Contact</th>
            <th>Images</th>
            <th>Status</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody></tbody>
</table>

<!-- Lightbox Modal -->
<div id="lightboxModal">
  <img id="lightboxImg">
  <button id="prevImg">&#10094;</button>
  <button id="nextImg">&#10095;</button>
</div>

<script>
let currentImages = [];
let currentImageIndex = 0;

function getListings(){ return JSON.parse(localStorage.getItem('listings')) || []; }
function saveListings(listings){ localStorage.setItem('listings', JSON.stringify(listings)); }

function renderListings(){
    const listings = getListings();
    const filter = document.getElementById('sectorFilter').value;
    const tbody = document.querySelector('#listingsTable tbody');
    tbody.innerHTML = '';

    listings.forEach((item,index)=>{
        if(filter !== 'All' && item.sector !== filter) return;
        const tr = document.createElement('tr');
        tr.className = item.sold ? 'sold':'';
        tr.innerHTML = `
            <td>${item.name}</td>
            <td>${item.sector}</td>
            <td>£${item.price}</td>
            <td>${item.quantity}</td>
            <td>${item.condition}</td>
            <td>${item.tags || ''}</td>
            <td>${item.contact}</td>
            <td>${item.images && item.images.length ? item.images.map((img,i)=>`<img class="listingImg" src="${img}" onclick="openLightbox(${index},${i})">`).join('') : ''}</td>
            <td>${item.sold ? 'Sold':'Available'}</td>
            <td>
                <button onclick="toggleSold(${index})">${item.sold ? 'Mark Available':'Mark Sold'}</button>
                <button onclick="deleteListing(${index})">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

function toggleSold(index){
    const listings = getListings();
    listings[index].sold = !listings[index].sold;
    saveListings(listings);
    renderListings();
}

function deleteListing(index){
    const listings = getListings();
    listings.splice(index,1);
    saveListings(listings);
    renderListings();
}

// ======= Lightbox =======
function openLightbox(listingIndex,imgIndex){
    const listings = getListings();
    currentImages = listings[listingIndex].images || [];
    if(!currentImages.length) return;
    currentImageIndex = imgIndex;
    document.getElementById('lightboxImg').src = currentImages[currentImageIndex];
    document.getElementById('lightboxModal').style.display='flex';
}

document.getElementById('prevImg').addEventListener('click', e=>{
    e.stopPropagation();
    currentImageIndex = (currentImageIndex-1+currentImages.length) % currentImages.length;
    document.getElementById('lightboxImg').src = currentImages[currentImageIndex];
});

document.getElementById('nextImg').addEventListener('click', e=>{
    e.stopPropagation();
    currentImageIndex = (currentImageIndex+1) % currentImages.length;
    document.getElementById('lightboxImg').src = currentImages[currentImageIndex];
});

document.getElementById('lightboxModal').addEventListener('click', e=>{
    if(e.target.id==='lightboxModal') e.currentTarget.style.display='none';
});

// ======= Initial Load =======
renderListings();
window.addEventListener('storage', renderListings);
</script>

</body>
</html>
